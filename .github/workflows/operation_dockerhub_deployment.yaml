# ECR ë ˆí¬ì§€í† ë¦¬ì— ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬
name: "Operation : Build & Deploy Image to ECR"

permissions:
  id-token: write # Configure AWS Credentialsì—ì„œ ID Token ì“°ê¸° ê¶Œí•œ ì‚¬ìš©
  contents: read  # Checkout Codeì—ì„œ ì½”ë“œ ì½ê¸° ê¶Œí•œ ì‚¬ìš©
  packages: read  # Retreive Artifactsì—ì„œ Artifact ì½ê¸° ê¶Œí•œ ì‚¬ìš©

on:
  workflow_call:          # workflow_call í˜¸ì¶œ
    inputs:
      REPOSITORY:             # ëª¨ë“ˆ ì´ë¦„
        required: true
        type: string
      NEW_TAG:            # ì¶”ê°€í•  íƒœê·¸, ì»¤ë°‹ì˜ SHA
        required: true
        type: string
    secrets:
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true

jobs:
  deploy-image:
    runs-on: ubuntu-latest # Github Hosted Ubuntu Runnerì—ì„œ ì‹¤í–‰
    steps:
      # ì¶”ê°€í•  ì´ë¯¸ì§€ íƒœê·¸ ì¶œë ¥
      - run: echo "ğŸ”– IMAGE TAG ${{ inputs.NEW_TAG }}"

      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v2

      # Docker Buildx ì„¤ì •
      - id: set-buildx
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Dockerhub ë¡œê·¸ì¸
      - id: login-docker
        name: Login to Dockerhub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Build & Deploy image to Dockerhub
      - id: build-push-image
        name: Build and Push Docker Image to ECR
        env:
          REPOSITORY: ${{ inputs.REPOSITORY }}                      # ëª¨ë“ˆ ì´ë¦„
          USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}                  # ECR ê³„ì • ì´ë¦„
          NEW_TAG: ${{ inputs.NEW_TAG }}                    # ì¶”ê°€í•  íƒœê·¸, ì»¤ë°‹ì˜ íƒœê·¸
        # ì´ë¯¸ì§€ amd64 ëŒ€ìƒìœ¼ë¡œ ë¹Œë“œ ë° ë°°í¬
        run: |
          docker buildx build --platform linux/amd64 -t $USERNAME/$REPOSITORY:$NEW_TAG --push .
          echo "ğŸ³ DOCKER IMAGE BUILT FOR REPOSITORY ${{ inputs.REPOSITORY }} AS $USERNAME/$REPOSITORY:$NEW_TAG"
          echo "ğŸš€ IMAGE $USERNAME/$REPOSITORY:$NEW_TAG PUSHED"