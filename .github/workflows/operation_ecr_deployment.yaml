# ECR ë ˆí¬ì§€í† ë¦¬ì— ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬
name: "Operation : Build & Deploy Image to ECR"

permissions:
  id-token: write # Configure AWS Credentialsì—ì„œ ID Token ì“°ê¸° ê¶Œí•œ ì‚¬ìš©
  contents: read  # Checkout Codeì—ì„œ ì½”ë“œ ì½ê¸° ê¶Œí•œ ì‚¬ìš©
  packages: read  # Retreive Artifactsì—ì„œ Artifact ì½ê¸° ê¶Œí•œ ì‚¬ìš©

on:
  workflow_call:          # workflow_call í˜¸ì¶œ
    inputs:
      MODULE:             # ëª¨ë“ˆ ì´ë¦„
        required: true
        type: string
      NEW_TAG:            # ì¶”ê°€í•  íƒœê·¸, ì»¤ë°‹ì˜ SHA
        required: true
        type: string
      USERNAME:           # ECR ê³„ì • ì´ë¦„
        required: true
        type: string
    secrets:
      AWS_ACCOUNT_ID:     # ECR ê³„ì • ID
        required: true
      AWS_REGION:         # ECR ë¦¬ì „
        required: true
      IAM_ROLE:           # IAM Role Assume ê¶Œí•œ
        required: true

jobs:
  deploy-image:
    runs-on: ubuntu-latest # Github Hosted Ubuntu Runnerì—ì„œ ì‹¤í–‰
    steps:
      # ì¶”ê°€í•  ì´ë¯¸ì§€ íƒœê·¸ ì¶œë ¥
      - run: echo "ğŸ”– IMAGE TAG ${{ inputs.NEW_TAG }}"

      # ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code
        uses: actions/checkout@v2

      # Artifact ë‹¤ìš´ë¡œë“œ
      - name: Retreive Artifacts
        uses: actions/download-artifact@v2
        with:
          name: ${{ inputs.MODULE }}-jar

      # Docker Buildx ì„¤ì •
      - id: set-buildx
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # AWS IAM Role Assume ê¶Œí•œ ì„¤ì •
      - id: configure-aws-credentials
        name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.IAM_ROLE }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ECR ë¡œê·¸ì¸
      - id: login-ecr
        name: Login to Amazon ECR Private 
        uses: aws-actions/amazon-ecr-login@v1

      # ECR ë ˆí¬ì§€í† ë¦¬ì— ì´ë¯¸ì§€ ë¹Œë“œ ë° ë°°í¬
      - id: build-push-image
        name: Build and Push Docker Image to ECR
        env:
          MODULE: ${{ inputs.MODULE }}                      # ëª¨ë“ˆ ì´ë¦„
          REGISTRY: ${{ steps.login-ecr.outputs.registry }} # ECR ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì£¼ì†Œ
          USERNAME: ${{ inputs.USERNAME }}                  # ECR ê³„ì • ì´ë¦„
          REPOSITORY: devops                                # ECR ë ˆí¬ì§€í† ë¦¬ ì´ë¦„
          NEW_TAG: ${{ inputs.NEW_TAG }}                    # ì¶”ê°€í•  íƒœê·¸, ì»¤ë°‹ì˜ íƒœê·¸
        # ì´ë¯¸ì§€ amd64 ëŒ€ìƒìœ¼ë¡œ ë¹Œë“œ ë° ë°°í¬
        run: |
          docker buildx build --platform linux/amd64 -t $REGISTRY/$USERNAME/$REPOSITORY/$MODULE:$NEW_TAG --target ${{ inputs.MODULE }} --push .
          echo "ğŸ³ DOCKER IMAGE BUILT FOR MODULE ${{ inputs.MODULE }} AS $REGISTRY/$USERNAME/$REPOSITORY/$MODULE:$NEW_TAG"
          echo "ğŸš€ IMAGE $REGISTRY/$USERNAME/$REPOSITORY/$MODULE:$NEW_TAG PUSHED"