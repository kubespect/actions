# ECR ì´ë¯¸ì§€ì— ìƒˆ íƒœê·¸ ì¶”ê°€
name: "Operation : Add Tag to Dockerhub Image"


permissions:
  id-token: write # Configure AWS Credentialsì—ì„œ ID Token ì“°ê¸° ê¶Œí•œ ì‚¬ìš©

on:
  workflow_call:              # workflow_call í˜¸ì¶œ
    inputs:
      MODULE:                 # ëª¨ë“ˆ ì´ë¦„
        required: true
        type: string
      EXISTING_TAG:           # ê¸°ì¡´ íƒœê·¸, ì»¤ë°‹ì˜ SHA
        required: true
        type: string
      NEW_TAG:                # ì¶”ê°€í•  íƒœê·¸, ì»¤ë°‹ì˜ íƒœê·¸
        required: true
        type: string
      USERNAME:               # ECR ê³„ì • ì´ë¦„
        required: true
        type: string
    secrets:
      AWS_ACCOUNT_ID:         # ECR ê³„ì • ID
        required: true
      AWS_REGION:             # ECR ë¦¬ì „
        required: true
      IAM_ROLE:               # IAM Role Assume ê¶Œí•œ
        required: true

jobs:
  add-tag:
    runs-on: ubuntu-latest  # Github Hosted Ubuntu Runnerì—ì„œ ì‹¤í–‰
    steps:
      # ì¶”ê°€í•  ì´ë¯¸ì§€ íƒœê·¸ ì¶œë ¥
      - run: echo "ğŸ”– IMAGE TAG ${{ inputs.NEW_TAG }}"

      # AWS IAM Role Assume ê¶Œí•œ ì„¤ì •
      - id: configure-aws-credentials
        name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.IAM_ROLE }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      # Dockerhub ë¡œê·¸ì¸
      - id: login-docker
        name: Login to Dockerhub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # í˜„ì¬ ì»¤ë°‹ì˜ ì´ë¯¸ì§€ê°€ ECRì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
      - id: check-image
        name: Check if image exists
        env:
          MODULE: ${{ inputs.MODULE }}                      # ëª¨ë“ˆ ì´ë¦„
          REGISTRY: ${{ steps.login-ecr.outputs.registry }} # ECR ë ˆí¬ì§€í† ë¦¬ ì£¼ì†Œ
          USERNAME: ${{ inputs.USERNAME }}                  # ECR ê³„ì • ì´ë¦„
          REPOSITORY: devops                                # ECR ë ˆí¬ì§€í† ë¦¬ ì´ë¦„
          EXISTING_TAG: ${{ inputs.EXISTING_TAG }}          # ê¸°ì¡´ íƒœê·¸, ì»¤ë°‹ì˜ SHA
        run: docker pull $REGISTRY/$USERNAME/$REPOSITORY/$MODULE:$EXISTING_TAG  # ì´ë¯¸ì§€ pull ì‹œë„
        continue-on-error: true
      
      # ì´ë¯¸ì§€ê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì¢…ë£Œ
      - id: check-image-output
        if: steps.check-image.outcome == 'failure'
        run: echo IMAGE NOT FOUND
      
      # ì´ë¯¸ì§€ê°€ ì¡´ì¬í•˜ë©´ ìƒˆ íƒœê·¸ ì¶”ê°€
      - id: add-image-tag
        if: steps.check-image.outcome == 'success'
        name: Add image tag with new git tag
        env:
          MODULE: ${{ inputs.MODULE }}                      # ëª¨ë“ˆ ì´ë¦„
          REGISTRY: ${{ steps.login-ecr.outputs.registry }} # ECR ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì£¼ì†Œ
          USERNAME: ${{ inputs.USERNAME }}                  # ECR ê³„ì • ì´ë¦„
          REPOSITORY: devops                                # ECR ë ˆí¬ì§€í† ë¦¬ ì´ë¦„
          EXISTING_TAG: ${{ inputs.EXISTING_TAG }}          # ê¸°ì¡´ íƒœê·¸, ì»¤ë°‹ì˜ SHA
          NEW_TAG: ${{ inputs.NEW_TAG }}                    # ì¶”ê°€í•  íƒœê·¸, ì»¤ë°‹ì˜ íƒœê·¸
        # ì´ë¯¸ì§€ë¥¼ pull í•˜ê³  ìƒˆ íƒœê·¸ë¥¼ ì¶”ê°€í•œ ë’¤ push
        run: |
          docker pull $REGISTRY/$USERNAME/$REPOSITORY/$MODULE:$EXISTING_TAG
          echo "ğŸ³ DOCKER IMAGE FOUND FOR MODULE ${{ inputs.MODULE }} AS $REGISTRY/$USERNAME/$REPOSITORY/$MODULE:$EXISTING_TAG"
          docker tag $REGISTRY/$USERNAME/$REPOSITORY/$MODULE:$EXISTING_TAG $REGISTRY/$USERNAME/$REPOSITORY/$MODULE:$NEW_TAG
          echo "ğŸ·ï¸ IMAGE TAGGED FOR MODULE ${{ inputs.MODULE }} AS $REGISTRY/$USERNAME/$REPOSITORY/$MODULE:$NEW_TAG"
          docker push $REGISTRY/$USERNAME/$REPOSITORY/$MODULE:$NEW_TAG
          echo "ğŸš€ IMAGE $REGISTRY/$USERNAME/$REPOSITORY/$MODULE:$NEW_TAG PUSHED"